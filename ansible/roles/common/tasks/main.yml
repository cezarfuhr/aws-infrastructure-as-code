---
- name: Update system packages
  yum:
    name: '*'
    state: latest
    update_cache: yes
  when: ansible_os_family == 'RedHat'

- name: Install common packages
  yum:
    name:
      - git
      - curl
      - wget
      - unzip
      - vim
      - htop
      - jq
      - python3
      - python3-pip
    state: present

- name: Configure system timezone
  timezone:
    name: America/New_York

- name: Configure NTP
  yum:
    name: chrony
    state: present

- name: Start and enable chronyd
  systemd:
    name: chronyd
    state: started
    enabled: yes

- name: Set system limits
  pam_limits:
    domain: '*'
    limit_type: "{{ item.limit_type }}"
    limit_item: "{{ item.limit_item }}"
    value: "{{ item.value }}"
  loop:
    - { limit_type: 'soft', limit_item: 'nofile', value: '65536' }
    - { limit_type: 'hard', limit_item: 'nofile', value: '65536' }
    - { limit_type: 'soft', limit_item: 'nproc', value: '4096' }
    - { limit_type: 'hard', limit_item: 'nproc', value: '4096' }

- name: Configure sysctl parameters
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: 'net.ipv4.tcp_tw_reuse', value: '1' }
    - { name: 'net.ipv4.ip_local_port_range', value: '10000 65535' }
    - { name: 'net.core.somaxconn', value: '4096' }
    - { name: 'vm.swappiness', value: '10' }
    - { name: 'vm.dirty_ratio', value: '15' }
    - { name: 'vm.dirty_background_ratio', value: '5' }

- name: Create application user
  user:
    name: "{{ app_user }}"
    comment: "Application User"
    shell: /bin/bash
    create_home: yes

- name: Create application directory
  file:
    path: "{{ app_directory }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'

- name: Configure SSH security
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^X11Forwarding', line: 'X11Forwarding no' }
  notify: restart sshd
